name: Deploy Tagged Release

on:
  push:
    tags:
      - 'v*'           # All version tags (v1.0.0, v1.0.0-rc.1, v1.0.0-beta.1)

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-deploy"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Extract version from tag
      id: version
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/v}"
        echo "version=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

        # Determine stage
        if [[ $TAG_NAME == *-beta.* ]]; then
          echo "stage=beta" >> $GITHUB_OUTPUT
          echo "is_stable=false" >> $GITHUB_OUTPUT
        elif [[ $TAG_NAME == *-rc.* ]]; then
          echo "stage=rc" >> $GITHUB_OUTPUT
          echo "is_stable=false" >> $GITHUB_OUTPUT
        else
          echo "stage=stable" >> $GITHUB_OUTPUT
          echo "is_stable=true" >> $GITHUB_OUTPUT
        fi

        echo "Version: $TAG_NAME"

    - name: Checkout repository with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.SUBMODULE_PAT }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'

    - name: Install Graphviz
      run: sudo apt-get update && sudo apt-get install -y graphviz

    - name: Install Python dependencies
      run: pip install -r requirements.txt

    - name: Build documentation with version
      env:
        DOCS_VERSION: ${{ steps.version.outputs.version }}
      run: |
        echo "Building documentation for version $DOCS_VERSION..."
        make html

        # Verify project docs
        for project in whisper deploy transfer; do
          if [ ! -f build/html/$project/index.html ]; then
            echo "ERROR: $project docs not found"
            exit 1
          fi
          echo "OK: $project"
        done

    - name: Checkout gh-pages branch
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: gh-pages
        token: ${{ secrets.SUBMODULE_PAT }}
      continue-on-error: true

    - name: Initialize gh-pages if needed
      run: |
        if [ ! -d gh-pages/.git ]; then
          mkdir -p gh-pages
          cd gh-pages
          git init
          git checkout -b gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit --allow-empty -m "Initialize gh-pages"
          cd ..
        fi

    - name: Add versioned documentation
      env:
        VERSION: ${{ steps.version.outputs.version }}
        IS_STABLE: ${{ steps.version.outputs.is_stable }}
      run: |
        # Remove old version directory if it exists (allows re-tagging)
        rm -rf "gh-pages/$VERSION"

        # Copy build output to versioned directory
        cp -r build/html "gh-pages/$VERSION"

        echo "Copied docs to gh-pages/$VERSION/"

        # Update latest symlink for stable releases
        if [ "$IS_STABLE" = "true" ]; then
          cd gh-pages
          rm -f latest
          ln -s "$VERSION" latest
          echo "Updated latest -> $VERSION"
          cd ..
        fi

    - name: Update versions.json
      env:
        VERSION: ${{ steps.version.outputs.version }}
        IS_STABLE: ${{ steps.version.outputs.is_stable }}
      run: |
        STABLE_FLAG=""
        if [ "$IS_STABLE" = "true" ]; then
          STABLE_FLAG="--stable"
        fi

        ./scripts/update-versions-json.sh \
          --version "$VERSION" \
          --url "/docs/$VERSION/" \
          $STABLE_FLAG \
          --file gh-pages/versions.json

    - name: Commit and push to gh-pages
      run: |
        cd gh-pages
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        git diff --cached --quiet && echo "No changes to commit" && exit 0
        git commit -m "Deploy ${{ steps.version.outputs.tag }}"
        git push origin gh-pages
        cd ..

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: gh-pages

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Deployment summary
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        STAGE="${{ steps.version.outputs.stage }}"
        echo "## Deployed: v$VERSION ($STAGE)"
        echo ""
        echo "**URL:** ${{ steps.deployment.outputs.page_url }}$VERSION/"
        echo "**Tag:** ${{ steps.version.outputs.tag }}"
        echo "**Commit:** $GITHUB_SHA"
